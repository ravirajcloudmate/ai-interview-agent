# Analytics & Insights Schema Documentation

This document describes the comprehensive analytics and insights system for the interview platform.

## Overview

The Analytics & Insights module provides real-time tracking and analysis of:
- Job postings and their performance
- Interview activities and outcomes
- Candidate engagement and hiring metrics
- Team activity and productivity
- System events and user interactions

## Database Tables

### 1. `analytics_metrics`
Stores aggregated metrics by time periods (daily, weekly, monthly).

**Key Fields:**
- `company_id`: Links to the company
- `metric_type`: 'daily', 'weekly', or 'monthly'
- `metric_date`: The date for the metrics
- Job metrics: `total_jobs`, `active_jobs`, `paused_jobs`, `closed_jobs`, `new_jobs`
- Interview metrics: `total_interviews`, `completed_interviews`, `scheduled_interviews`, `cancelled_interviews`, `new_interviews`
- Candidate metrics: `total_candidates`, `new_candidates`, `interviewed_candidates`, `hired_candidates`, `rejected_candidates`
- Report metrics: `total_reports`, `new_reports`, `hire_recommendations`, `maybe_recommendations`, `no_hire_recommendations`
- Performance metrics: `average_interview_duration`, `average_hire_rate`, `average_time_to_hire`
- Team metrics: `active_users`, `total_invitations_sent`, `total_invitations_accepted`

### 2. `analytics_events` (Enhanced)
Tracks all user and system events for audit and analysis.

**Key Fields:**
- `company_id`: Links to the company
- `user_id`: Links to the user who triggered the event
- `event_type`: Type of event (e.g., 'job_created', 'interview_completed')
- `event_category`: Category ('job', 'interview', 'candidate', 'report', 'user', 'system')
- `event_action`: Action ('created', 'updated', 'deleted', 'viewed', 'completed')
- `metadata`: JSONB field for additional event data
- `session_id`, `ip_address`, `user_agent`: For tracking and security

### 3. `analytics_trends`
Stores trend data for charts and visualizations.

**Key Fields:**
- `company_id`: Links to the company
- `trend_type`: Type of trend ('jobs', 'interviews', 'candidates', 'reports', 'hires')
- `trend_period`: Period ('daily', 'weekly', 'monthly')
- `trend_date`: Date for the trend
- `value`: The trend value
- `previous_value`: Previous period value for comparison
- `change_percentage`: Percentage change from previous period

### 4. `analytics_insights`
Stores AI-generated insights and recommendations.

**Key Fields:**
- `company_id`: Links to the company
- `insight_type`: Type ('performance', 'trend', 'recommendation', 'alert')
- `insight_category`: Category ('hiring', 'efficiency', 'quality', 'team')
- `title`: Insight title
- `description`: Detailed description
- `insight_data`: JSONB field for additional data
- `priority`: Priority level ('low', 'medium', 'high', 'critical')
- `status`: Status ('active', 'dismissed', 'resolved')
- `is_ai_generated`: Whether the insight was generated by AI

### 5. `analytics_dashboard_settings`
Stores user preferences for dashboard widgets.

**Key Fields:**
- `company_id`: Links to the company
- `user_id`: Links to the user (optional, for personal settings)
- `widget_type`: Type of widget ('kpi', 'chart', 'table', 'insight')
- `widget_config`: JSONB configuration for the widget
- `position`: Display position
- `is_visible`: Whether the widget is visible

## Database Functions

### 1. `get_company_analytics(company_id, date_range)`
Returns comprehensive analytics data for a company.

**Returns:**
- Total counts for jobs, interviews, candidates, reports
- Hire rate percentage
- Active/paused job counts
- Today's activity counts

### 2. `get_analytics_trends(company_id, trend_type, days)`
Returns trend data for charts.

**Parameters:**
- `company_id`: Company UUID
- `trend_type`: 'jobs', 'interviews', 'reports'
- `days`: Number of days to look back

### 3. `log_analytics_event(company_id, user_id, event_type, event_category, event_action, metadata)`
Logs an analytics event.

**Returns:** Event ID

### 4. `calculate_all_daily_metrics(date)`
Calculates and stores daily metrics for all companies.

### 5. `calculate_weekly_metrics(week_start)`
Calculates and stores weekly metrics by aggregating daily metrics.

### 6. `calculate_monthly_metrics(month_start)`
Calculates and stores monthly metrics by aggregating daily metrics.

### 7. `update_analytics_trends(date)`
Updates trend data for a specific date.

## Automatic Event Logging

The system automatically logs events through database triggers:

### Job Events
- `job_created`: When a new job is created
- `job_updated`: When a job is updated
- `job_deleted`: When a job is deleted

### Interview Events
- `interview_created`: When a new interview is created
- `interview_updated`: When an interview is updated

### Report Events
- `report_generated`: When a new interview report is generated

## Real-time Updates

The system uses Supabase real-time subscriptions to automatically update the UI when:
- New jobs are created/updated/deleted
- New interviews are created/updated
- New reports are generated
- New analytics events are logged

## Security (RLS Policies)

All tables have Row Level Security (RLS) enabled with policies that ensure:
- Users can only access data from their company
- System functions can insert/update analytics data
- Admins have additional permissions for insights management
- Users can manage their own dashboard settings

## Usage in Frontend

The `AnalyticsInsights` component:
1. Uses `get_company_analytics()` for KPI data
2. Uses `get_analytics_trends()` for chart data
3. Queries `analytics_events` for recent activity
4. Subscribes to real-time updates
5. Falls back to individual queries if RPC functions are unavailable

## Setup Instructions

1. Run the schema files in order:
   ```sql
   -- Run these in your Supabase SQL editor
   \i 22_analytics_insights.sql
   \i 23_analytics_insights_policies.sql
   \i 24_analytics_scheduler.sql
   ```

2. (Optional) Set up automatic scheduling with pg_cron:
   ```sql
   -- Enable pg_cron extension (requires superuser)
   CREATE EXTENSION IF NOT EXISTS pg_cron;
   
   -- Schedule daily metrics calculation at 1 AM
   SELECT cron.schedule('daily-analytics', '0 1 * * *', 'SELECT calculate_all_daily_metrics();');
   
   -- Schedule weekly metrics calculation on Mondays at 2 AM
   SELECT cron.schedule('weekly-analytics', '0 2 * * 1', 'SELECT calculate_weekly_metrics();');
   
   -- Schedule monthly metrics calculation on the 1st at 3 AM
   SELECT cron.schedule('monthly-analytics', '0 3 1 * *', 'SELECT calculate_monthly_metrics();');
   
   -- Schedule daily trends update at midnight
   SELECT cron.schedule('daily-trends', '0 0 * * *', 'SELECT update_analytics_trends();');
   ```

3. Manually trigger initial data calculation:
   ```sql
   -- Calculate metrics for the last 30 days
   SELECT calculate_all_daily_metrics(CURRENT_DATE - INTERVAL '30 days');
   SELECT calculate_all_daily_metrics(CURRENT_DATE - INTERVAL '29 days');
   -- ... continue for each day
   
   -- Or calculate for today
   SELECT calculate_all_daily_metrics(CURRENT_DATE);
   ```

## Performance Considerations

- All tables have appropriate indexes for fast queries
- RPC functions are optimized for performance
- Real-time subscriptions are debounced to prevent excessive updates
- Fallback queries ensure the system works even if RPC functions fail
- Metrics are pre-calculated to avoid expensive real-time calculations

## Future Enhancements

Potential future features:
- AI-powered insights generation
- Custom dashboard widgets
- Advanced filtering and segmentation
- Export capabilities
- Integration with external analytics tools
- Predictive analytics for hiring trends

